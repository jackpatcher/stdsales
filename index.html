<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; }
        .toast {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <div class="bg-white shadow-lg border-b-4 border-blue-500">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <input id="editableTitle" type="text" class="text-3xl font-bold text-gray-800 text-center w-full bg-transparent border-none outline-none cursor-pointer hover:bg-blue-50 rounded transition px-2 py-1" style="min-width:200px; max-width:100%;" value="üìä ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" />
            <p class="text-center text-gray-600 mt-2">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Å‡∏•‡∏∏‡πà‡∏°</p>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="max-w-7xl mx-auto px-6 mt-6">
        <div class="flex bg-white rounded-lg shadow-md p-1">
            <button id="chartTab" class="flex-1 py-3 px-6 rounded-md font-medium transition-all duration-200 bg-blue-500 text-white">
                üìä ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏£‡∏≤‡∏ü
            </button>
            <button id="dataTab" class="flex-1 py-3 px-6 rounded-md font-medium transition-all duration-200 text-gray-600 hover:bg-gray-100">
                üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </button>
        </div>
    </div>

    <!-- Data Entry Tab -->
    <div id="dataContent" class="max-w-7xl mx-auto px-2 mt-6">
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white rounded-xl shadow-lg text-center align-middle">
                <thead class="bg-blue-100">
                    <tr>
                        <th class="py-2 px-2 border-b text-sm">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà</th>
                        <th class="py-2 px-2 border-b text-sm">‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à</th>
                        <th class="py-2 px-2 border-b text-sm">‡∏Ç‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 1<br><span class="text-xs text-gray-500">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ / ‡∏ó‡∏∏‡∏ô</span></th>
                        <th class="py-2 px-2 border-b text-sm">‡∏Ç‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 2<br><span class="text-xs text-gray-500">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ / ‡∏ó‡∏∏‡∏ô</span></th>
                        <th class="py-2 px-2 border-b text-sm">‡∏Ç‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 3<br><span class="text-xs text-gray-500">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ / ‡∏ó‡∏∏‡∏ô</span></th>
                        <th class="py-2 px-2 border-b text-sm">‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á</th>
                        <th class="py-2 px-2 border-b text-sm">‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</th>
                        <th class="py-2 px-2 border-b text-sm">‡∏Å‡∏≥‡πÑ‡∏£‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≠‡∏ö</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                    <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏∏‡πà‡∏° 1-8 ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JS -->
                </tbody>
            </table>
        </div>
    </div>

 

           

    <!-- Chart Tab -->
    <div id="chartContent" class="max-w-7xl mx-auto px-6 mt-6 hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white rounded-xl shadow-lg p-6" style="height: 350px;">
                <canvas id="salesChart"></canvas>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6" style="height: 350px;">
                <canvas id="profitChart"></canvas>
            </div>
        </div>
        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-gradient-to-r from-green-400 to-green-600 rounded-xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-green-100 text-sm font-medium">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</p>
                        <p id="totalSales" class="text-3xl font-bold">0 ‡∏ö‡∏≤‡∏ó</p>
                    </div>
                    <div class="bg-white bg-opacity-20 rounded-full p-3">
                        <span class="text-2xl">üí∞</span>
                    </div>
                </div>
            </div>
            <div class="bg-gradient-to-r from-blue-400 to-blue-600 rounded-xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-blue-100 text-sm font-medium">‡∏Å‡∏≥‡πÑ‡∏£‡∏£‡∏ß‡∏°</p>
                        <p id="totalProfit" class="text-3xl font-bold">0 ‡∏ö‡∏≤‡∏ó</p>
                    </div>
                    <div class="bg-white bg-opacity-20 rounded-full p-3">
                        <span class="text-2xl">üìà</span>
                    </div>
                </div>
            </div>
            <div class="bg-gradient-to-r from-purple-400 to-purple-600 rounded-xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-purple-100 text-sm font-medium">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ‡∏™‡∏∏‡∏î</p>
                        <p id="bestGroup" class="text-3xl font-bold">-</p>
                    </div>
                    <div class="bg-white bg-opacity-20 rounded-full p-3">
                        <span class="text-2xl">üèÜ</span>
                    </div>
                </div>
            </div>
        </div>

 

        <!-- Analysis -->
        <div class="bg-white rounded-xl shadow-lg p-6 mt-8">
            <h3 class="text-xl font-bold text-gray-800 mb-4">üîç ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h3>
            <div id="analysis" class="text-gray-700 leading-relaxed">
                <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</p>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <script>

        // --- Data Sync Functions ---
        function encodeBase64(str) {
            return btoa(unescape(encodeURIComponent(str)));
        }
        function decodeBase64(str) {
            try {
                return decodeURIComponent(escape(atob(str)));
            } catch {
                return '';
            }
        }

        function getAllAppData() {
            // Gather all app data (title, salesData)
            const title = document.getElementById('editableTitle').value.trim();
            return {
                title,
                salesData: salesData || {}
            };
        }

        function setAllAppData(data) {
            // Set all app data and persist to localStorage and URL param
            salesData = data.salesData || {};
            // Set title
            if (data.title) {
                document.getElementById('editableTitle').value = data.title;
            }
            // Save to localStorage
            localStorage.setItem('allAppData', JSON.stringify(data));
            // Update URL param
            updateUrlDataParam(data);
        }

        function updateUrlDataParam(data) {
            const json = JSON.stringify(data);
            const encoded = encodeBase64(json);
            const url = new URL(window.location.href);
            url.searchParams.set('data', encoded);
            window.history.replaceState({}, '', url);
        }

        function loadDataFromUrlParam() {
            const url = new URL(window.location.href);
            const encoded = url.searchParams.get('data');
            if (encoded) {
                const json = decodeBase64(encoded);
                try {
                    return JSON.parse(json);
                } catch {
                    return null;
                }
            }
            return null;
        }

        function saveAllAppData() {
            setAllAppData(getAllAppData());
        }

        // --- End Data Sync Functions ---

        let salesData = {};
        let charts = {};

        // Render table rows for groups 1-8
        function renderDataTable() {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            for (let group = 1; group <= 8; group++) {
                const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-blue-50';
                // ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà
                const tdGroup = document.createElement('td');
                tdGroup.className = 'py-2 px-2 font-bold';
                tdGroup.textContent = `‡∏Å‡∏•‡∏∏‡πà‡∏° ${group}`;
                tr.appendChild(tdGroup);
                // ‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à
                const tdBiz = document.createElement('td');
                tdBiz.className = 'py-2 px-2';
                const bizInput = document.createElement('input');
                bizInput.type = 'text';
                bizInput.className = 'business-input w-28 px-1 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-400 focus:border-transparent text-sm';
                bizInput.placeholder = '‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à';
                bizInput.setAttribute('data-group', group);
                tdBiz.appendChild(bizInput);
                tr.appendChild(tdBiz);
                // ‡∏Ç‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 1-3
                for (let round = 1; round <= 3; round++) {
                    const td = document.createElement('td');
                    td.className = 'py-2 px-2';
                    const salesInput = document.createElement('input');
                    salesInput.type = 'number';
                    salesInput.className = 'sales-input w-20 px-1 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-400 focus:border-transparent text-sm mb-1';
                    salesInput.placeholder = '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢';
                    salesInput.setAttribute('data-group', group);
                    salesInput.setAttribute('data-round', round);
                    salesInput.setAttribute('data-type', 'sales');
                    td.appendChild(salesInput);
                    td.appendChild(document.createElement('br'));
                    const costInput = document.createElement('input');
                    costInput.type = 'number';
                    costInput.className = 'cost-input w-20 px-1 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-400 focus:border-transparent text-sm';
                    costInput.placeholder = '‡∏ó‡∏∏‡∏ô';
                    costInput.setAttribute('data-group', group);
                    costInput.setAttribute('data-round', round);
                    costInput.setAttribute('data-type', 'cost');
                    td.appendChild(costInput);
                    tr.appendChild(td);
                }
                // ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á
                const tdImprove = document.createElement('td');
                tdImprove.className = 'py-2 px-2';
                const improveInput = document.createElement('textarea');
                improveInput.className = 'improvement-input w-28 px-1 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-400 focus:border-transparent text-xs resize-none';
                improveInput.rows = 2;
                improveInput.setAttribute('data-group', group);
                improveInput.placeholder = '‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á...';
                tdImprove.appendChild(improveInput);
                tr.appendChild(tdImprove);
                // ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
                const tdDoc = document.createElement('td');
                tdDoc.className = 'py-2 px-2';
                const docInput = document.createElement('input');
                docInput.type = 'url';
                docInput.className = 'document-input w-28 px-1 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-400 focus:border-transparent text-xs';
                docInput.setAttribute('data-group', group);
                docInput.placeholder = '‡∏•‡∏¥‡∏á‡∏Å‡πå';
                tdDoc.appendChild(docInput);
                tr.appendChild(tdDoc);
                // ‡∏Å‡∏≥‡πÑ‡∏£‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≠‡∏ö
                const tdProfit = document.createElement('td');
                tdProfit.className = 'py-2 px-2';
                const profitDiv = document.createElement('div');
                profitDiv.className = 'profit-display text-xs font-medium text-green-600';
                profitDiv.setAttribute('data-group', group);
                tdProfit.appendChild(profitDiv);
                tr.appendChild(tdProfit);
                tbody.appendChild(tr);
            }
        }

        // Initialize

        document.addEventListener('DOMContentLoaded', function() {
            renderDataTable();
            initializeEventListeners();
            // Load from URL param if present, else from localStorage
            let loaded = loadDataFromUrlParam();
            if (!loaded) {
                try {
                    loaded = JSON.parse(localStorage.getItem('allAppData') || '{}');
                } catch { loaded = null; }
            }
            if (loaded && (loaded.salesData || loaded.title)) {
                setAllAppData(loaded);
                restoreInputsFromSalesData();
            } else {
                // No data, just render empty
                salesData = {};
            }
            // Restore input values (if not already done)
            restoreInputsFromSalesData();
            // Restore title (if not already done)
            if (loaded && loaded.title) {
                document.getElementById('editableTitle').value = loaded.title;
            }
            // Editable title listeners
            const titleEl = document.getElementById('editableTitle');
            titleEl.addEventListener('input', function() {
                saveAllAppData();
            });
            titleEl.addEventListener('blur', function() {
                saveAllAppData();
            });
            // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏£‡∏≤‡∏ü
            switchTab('chart');
        });

        // Re-bind input listeners after table re-render (for dynamic table)

        function rebindTableInputListeners() {
            document.querySelectorAll('.sales-input, .cost-input').forEach(input => {
                input.removeEventListener('input', handleInputChange);
                input.addEventListener('input', handleInputChange);
            });
            document.querySelectorAll('.improvement-input, .document-input, .business-input').forEach(input => {
                input.removeEventListener('input', handleOtherInputChange);
                input.addEventListener('input', handleOtherInputChange);
            });
        }

        // Patch renderDataTable to always rebind listeners
        const _renderDataTable = renderDataTable;
        renderDataTable = function() {
            _renderDataTable();
            rebindTableInputListeners();
        }


        function initializeEventListeners() {
            // Tab switching
            document.getElementById('dataTab').addEventListener('click', () => switchTab('data'));
            document.getElementById('chartTab').addEventListener('click', () => switchTab('chart'));

            // Input listeners
            document.querySelectorAll('.sales-input, .cost-input').forEach(input => {
                input.addEventListener('input', handleInputChange);
            });

            document.querySelectorAll('.improvement-input, .document-input, .business-input').forEach(input => {
                input.addEventListener('input', handleOtherInputChange);
            });
        }

        function switchTab(tab) {
            const dataTab = document.getElementById('dataTab');
            const chartTab = document.getElementById('chartTab');
            const dataContent = document.getElementById('dataContent');
            const chartContent = document.getElementById('chartContent');

            if (tab === 'data') {
                dataTab.className = 'flex-1 py-3 px-6 rounded-md font-medium transition-all duration-200 bg-blue-500 text-white';
                chartTab.className = 'flex-1 py-3 px-6 rounded-md font-medium transition-all duration-200 text-gray-600 hover:bg-gray-100';
                dataContent.classList.remove('hidden');
                chartContent.classList.add('hidden');
            } else {
                chartTab.className = 'flex-1 py-3 px-6 rounded-md font-medium transition-all duration-200 bg-blue-500 text-white';
                dataTab.className = 'flex-1 py-3 px-6 rounded-md font-medium transition-all duration-200 text-gray-600 hover:bg-gray-100';
                dataContent.classList.add('hidden');
                chartContent.classList.remove('hidden');
                chartContent.classList.remove('hidden');
                updateCharts();
            }
        }


        function handleInputChange(event) {
            const input = event.target;
            const group = input.dataset.group;
            const round = input.dataset.round;
            const type = input.dataset.type;

            if (!salesData[group]) salesData[group] = {};
            if (!salesData[group][round]) salesData[group][round] = {};

            salesData[group][round][type] = parseFloat(input.value) || 0;

            // Calculate and display profit
            updateProfitDisplay(group, round);
            saveAllAppData();
            updateCharts();
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß', 'success');
        }

        function handleOtherInputChange(event) {
            // For improvement, document, and business name inputs
            const input = event.target;
            const group = input.dataset.group;
            if (!salesData[group]) salesData[group] = {};
            if (input.classList.contains('improvement-input')) {
                salesData[group].improvement = input.value;
            } else if (input.classList.contains('document-input')) {
                salesData[group].document = input.value;
            } else if (input.classList.contains('business-input')) {
                salesData[group].business = input.value;
            }
            saveAllAppData();
        }

        function updateProfitDisplay(group, round) {
            // Show profit for all 3 rounds in the same cell (for table version)
            const profitDisplay = document.querySelector(`.profit-display[data-group="${group}"]`);
            let profitText = [];
            for (let r = 1; r <= 3; r++) {
                const data = salesData[group] && salesData[group][r];
                if (data && (data.sales || data.cost)) {
                    const sales = parseFloat(data.sales) || 0;
                    const cost = parseFloat(data.cost) || 0;
                    const profit = sales - cost;
                    const percent = cost > 0 ? ((profit / cost) * 100).toFixed(1) : '';
                    let text = '';
                    if (!isNaN(profit)) {
                        text = `<span class='${profit >= 0 ? 'text-green-600' : 'text-red-600'}'>${profit.toLocaleString()}${percent !== '' ? ` (${percent}%)` : ''}</span>`;
                    }
                    profitText.push(text);
                } else {
                    profitText.push('');
                }
            }
            if (profitDisplay) {
                profitDisplay.innerHTML = profitText.join(' / ');
            }
        }

        function updateCharts() {
            updateSummaryCards();
            updateSalesChart();
            updateProfitChart();
            updateAnalysis();
        }

        function updateSummaryCards() {
            let totalSales = 0;
            let totalCost = 0;
            let bestGroup = '';
            let bestSales = 0;

            for (let group = 1; group <= 8; group++) {
                let groupSales = 0;
                for (let round = 1; round <= 3; round++) {
                    const data = salesData[group] && salesData[group][round];
                    if (data) {
                        totalSales += data.sales || 0;
                        totalCost += data.cost || 0;
                        groupSales += data.sales || 0;
                    }
                }
                if (groupSales > bestSales) {
                    bestSales = groupSales;
                    bestGroup = `‡∏Å‡∏•‡∏∏‡πà‡∏° ${group}`;
                }
            }

            document.getElementById('totalSales').textContent = totalSales.toLocaleString() + ' ‡∏ö‡∏≤‡∏ó';
            document.getElementById('totalProfit').textContent = (totalSales - totalCost).toLocaleString() + ' ‡∏ö‡∏≤‡∏ó';
            document.getElementById('bestGroup').textContent = bestGroup || '-';
        }

        function updateSalesChart() {
            const ctx = document.getElementById('salesChart').getContext('2d');
            if (charts.sales) {
                charts.sales.destroy();
            }
            const datasets = [];
            const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6', '#6366f1', '#8b5cf6', '#ec4899'];
            for (let group = 1; group <= 8; group++) {
                const data = [];
                for (let round = 1; round <= 3; round++) {
                    const roundData = salesData[group] && salesData[group][round];
                    data.push(roundData ? (roundData.sales || 0) : 0);
                }
                datasets.push({
                    label: `‡∏Å‡∏•‡∏∏‡πà‡∏° ${group}`,
                    data: data,
                    borderColor: colors[group - 1],
                    backgroundColor: colors[group - 1] + '20',
                    tension: 0.4
                });
            }
            charts.sales = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 1', '‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 2', '‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 3'],
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 16/9,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + ' ‡∏ö‡∏≤‡∏ó';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateProfitChart() {
            const ctx = document.getElementById('profitChart').getContext('2d');
            if (charts.profit) {
                charts.profit.destroy();
            }
            const data = [];
            const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6', '#6366f1', '#8b5cf6', '#ec4899'];
            for (let group = 1; group <= 8; group++) {
                let totalSales = 0;
                let totalCost = 0;
                for (let round = 1; round <= 3; round++) {
                    const roundData = salesData[group] && salesData[group][round];
                    if (roundData) {
                        totalSales += roundData.sales || 0;
                        totalCost += roundData.cost || 0;
                    }
                }
                const profitPercent = totalCost > 0 ? ((totalSales - totalCost) / totalCost * 100) : 0;
                data.push(profitPercent);
            }
            charts.profit = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 8}, (_, i) => `‡∏Å‡∏•‡∏∏‡πà‡∏° ${i + 1}`),
                    datasets: [{
                        label: '‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Å‡∏≥‡πÑ‡∏£',
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 16/9,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateAnalysis() {
            const analysisDiv = document.getElementById('analysis');
            let analysis = '<div class="space-y-4">';

            // Find best and worst performing groups
            let groupPerformance = [];
            for (let group = 1; group <= 8; group++) {
                let totalSales = 0;
                let totalCost = 0;
                let rounds = 0;

                for (let round = 1; round <= 3; round++) {
                    const data = salesData[group] && salesData[group][round];
                    if (data && data.sales > 0) {
                        totalSales += data.sales;
                        totalCost += data.cost || 0;
                        rounds++;
                    }
                }

                if (rounds > 0) {
                    const profitPercent = totalCost > 0 ? ((totalSales - totalCost) / totalCost * 100) : 0;
                    groupPerformance.push({
                        group: group,
                        sales: totalSales,
                        profit: totalSales - totalCost,
                        profitPercent: profitPercent,
                        rounds: rounds
                    });
                }
            }

            if (groupPerformance.length === 0) {
                analysis += '<p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</p>';
            } else {
                groupPerformance.sort((a, b) => b.sales - a.sales);
                
                analysis += `<div class="bg-green-50 border-l-4 border-green-400 p-4 rounded">`;
                analysis += `<h4 class="font-semibold text-green-800 mb-2">üèÜ ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</h4>`;
                analysis += `<p class="text-green-700">‡∏Å‡∏•‡∏∏‡πà‡∏° ${groupPerformance[0].group} ‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ${groupPerformance[0].sales.toLocaleString()} ‡∏ö‡∏≤‡∏ó `;
                analysis += `‡∏Å‡∏≥‡πÑ‡∏£ ${groupPerformance[0].profit.toLocaleString()} ‡∏ö‡∏≤‡∏ó (${groupPerformance[0].profitPercent.toFixed(1)}%)</p>`;
                analysis += `</div>`;

                if (groupPerformance.length > 1) {
                    const worst = groupPerformance[groupPerformance.length - 1];
                    analysis += `<div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">`;
                    analysis += `<h4 class="font-semibold text-yellow-800 mb-2">üìà ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á</h4>`;
                    analysis += `<p class="text-yellow-700">‡∏Å‡∏•‡∏∏‡πà‡∏° ${worst.group} ‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î ${worst.sales.toLocaleString()} ‡∏ö‡∏≤‡∏ó `;
                    analysis += `‡∏Ñ‡∏ß‡∏£‡∏´‡∏≤‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏•‡∏î‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</p>`;
                    analysis += `</div>`;
                }

                // Average performance
                const avgSales = groupPerformance.reduce((sum, g) => sum + g.sales, 0) / groupPerformance.length;
                const avgProfit = groupPerformance.reduce((sum, g) => sum + g.profitPercent, 0) / groupPerformance.length;
                
                analysis += `<div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded">`;
                analysis += `<h4 class="font-semibold text-blue-800 mb-2">üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h4>`;
                analysis += `<p class="text-blue-700">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ${avgSales.toLocaleString()} ‡∏ö‡∏≤‡∏ó ‡∏Å‡∏≥‡πÑ‡∏£‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ${avgProfit.toFixed(1)}%</p>`;
                analysis += `<p class="text-blue-700">‡∏°‡∏µ ${groupPerformance.length} ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</p>`;
                analysis += `</div>`;
            }

            analysis += '</div>';
            analysisDiv.innerHTML = analysis;
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            
            toast.className = `toast ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg flex items-center space-x-2`;
            toast.innerHTML = `
                <span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span>
                <span>${message}</span>
            `;

            document.getElementById('toastContainer').appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }


        function restoreInputsFromSalesData() {
            // Restore all input values from salesData
            for (let group = 1; group <= 8; group++) {
                if (salesData[group]) {
                    // Business name
                    const bizInput = document.querySelector(`[data-group="${group}"].business-input`);
                    if (bizInput) {
                        bizInput.value = salesData[group].business || '';
                    }
                    for (let round = 1; round <= 3; round++) {
                        if (salesData[group][round]) {
                            const salesInput = document.querySelector(`[data-group="${group}"][data-round="${round}"][data-type="sales"]`);
                            const costInput = document.querySelector(`[data-group="${group}"][data-round="${round}"][data-type="cost"]`);
                            if (salesInput) {
                                salesInput.value = salesData[group][round].sales || '';
                            }
                            if (costInput) {
                                costInput.value = salesData[group][round].cost || '';
                            }
                            updateProfitDisplay(group, round);
                        }
                    }
                    // Restore improvement and document inputs
                    const improvementInput = document.querySelector(`[data-group="${group}"].improvement-input`);
                    const documentInput = document.querySelector(`[data-group="${group}"].document-input`);
                    if (improvementInput) {
                        improvementInput.value = salesData[group].improvement || '';
                    }
                    if (documentInput) {
                        documentInput.value = salesData[group].document || '';
                    }
                }
            }
        }
    </script>
 </html>
